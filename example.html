<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <script src="lib/vdom.js"></script>
</head>
<body>
<script type="text/javascript">

function render(node) {
    var res;

    if('text' in node) {
        res = document.createTextNode(node.text);
    }
    else {
        res = document.createElement(node.tag);
        for(var name in node.attrs) {
            res[name] = node.attrs[name];
        }

        var children = node.children;
        if(children) {
            var i = 0, child;
            while(child = children[i++]) {
                res.appendChild(render(child));
            }
        }
    }

    return node.domNode = res;
}

function insertAt(parentNode, node, idx) {
    idx < parentNode.childNodes.length - 1?
        parentNode.insertBefore(node, parentNode.childNodes[idx + 1]) :
        parentNode.appendChild(node);
}

function applyPatch(patch) {
    var i = 0, op;
    while(op = patch[i++]) {
        console.log(op);
        switch(op.type) {
            case 'updateText':
                getDomNode(op.node).nodeValue = op.text;
            break;

            case 'replaceNode':
                var oldNode = op.oldNode,
                    oldDomNode = getDomNode(oldNode),
                    newDomNode = render(op.newNode);

                oldDomNode.parentNode.replaceChild(newDomNode, oldDomNode);
            break;

            case 'updateAttr':
                getDomNode(op.node)[op.attrName] = op.attrVal;
            break;

            case 'removeAttr':
                getDomNode(op.node).removeAttribute(op.attrName);
            break;

            case 'appendChild':
                getDomNode(op.parentNode).appendChild(render(op.childNode));
            break;

            case 'removeChild':
                getDomNode(op.parentNode).removeChild(getDomNode(op.childNode));
            break;

            case 'insertChild':
                insertAt(getDomNode(op.parentNode), render(op.childNode), op.idx);
            break;

            case 'moveChild':
                insertAt(getDomNode(op.parentNode), getDomNode(op.childNode), op.idx);
            break;

            case 'removeChildren':
                getDomNode(op.parentNode).innerHTML = '';
            break;

            default:
                throw Error('unsupported operation: ' + op.type);
        }
    }
}

function getDomNode(node) {
    if(node.domNode) {
        return node.domNode;
    }

    var prevNode = node;
    while(prevNode = prevNode.prevNode) {
        if(prevNode.domNode) {
            return node.domNode = prevNode.domNode;
        }
    }

    throw Error('can\'t get dom node');
}

var batch = [];

function scheduleUpdate(patch) {
    if(!batch.length) {
        window.requestAnimationFrame(performUpdate);
    }

    batch = batch.concat(patch);
}

function performUpdate() {
    applyPatch(batch);
    batch = [];
}

var tree = {
        tag : 'a',
        children : [
            { tag : 'i', key : 1 },
            { tag : 'i', key : 2 },
            { tag : 'i', key : 3 }
        ]
    };

document.body.appendChild(render(tree));

[{
        tag : 'a',
        attrs : { disabled : true, tabIndex : 10 },
        children : [
            {
                tag : 'b',
                attrs : { className : 'aa' }
            },
            { tag : 'i', key : 2 },
            { tag : 'i', children : [{ text : 'text12' }], key : 3, attrs : { className : 'test test_a' } },
            { tag : 'i', key : 1, children : [] }
        ]
},
{
    tag : 'a',
    children : [
        {
            tag : 'b',
            attrs : { className : 'aa' },
            children : []
        },
        { tag : 'i', children : [], key : 1 },
        { tag : 'i', children : [{ text : 'text' }], key : 2 },
        { tag : 'i', children : [{ text : 'text123' }], key : 3, attrs : { className : 'test test_a' } }
    ]
},
{
    tag : 'a',
    children : [
        {
            tag : 'b',
            attrs : { className : 'aa' },
            children : []
        },
        { tag : 'i', children : [], key : 1 },
        { tag : 'i', children : [{ text : 'text' }], key : 2 },
        { tag : 'i', children : [{ text : 'text1234' }], key : 3, attrs : { className : 'test test_a' } }
    ]
},
{
    tag : 'a',
    children : [
        {
            tag : 'b',
            attrs : { className : 'aa' },
            children : []
        },
        { tag : 'i', children : [], key : 1 },
        { tag : 'i', children : [{ text : 'text' }], key : 2 },
        { tag : 'i', children : [{ text : 'text12345' }], key : 3, attrs : { className : 'test test_a' } }
    ]
},

{
    tag : 'a',
    attrs : { disabled : 'disabled', tabIndex : 10 },
    children : [
        { tag : 'i', children : [] },
        {
            tag : 'b',
            children : []
        },
        { tag : 'a', attrs : { href : '/' }, children : [{ text : 'link' }] },
        { tag : 'input', attrs : { type : 'radio', checked : true }, children : [] },
        { text : 'text1' }
    ]
},
{
    tag : 'a',
    attrs : { disabled : 'disabled', tabIndex : 10 },
    children : [
        { tag : 'i', children : [] },
        {
            tag : 'b',
            children : []
        },
        { tag : 'a', children : [{ text : 'link' }] },
        { tag : 'input', attrs : { type : 'radio', checked : false }, children : [] },
        { tag : 'b', children : [] }
    ]
}
].reduce(
    function(treeA, treeB) {
        scheduleUpdate(
            vdom.diff(
                treeA,
                treeB));
        return treeB;
    },
    tree);

</script>
</body>
</html>
